<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Logs Search</title>
  <style>
    body{font-family:system-ui,Arial;padding:18px}
    pre{white-space:pre-wrap}
  </style>
</head>
<body>
  <h1>Logs Search (example)</h1>

  <div>
    <label>Keywords (comma): <input id="kw" value="error,login" style="width:60%"></label>
  </div>
  <div>
    <label>Limit: <input id="limit" type="number" value="10" min="1" max="500"></label>
    <button id="search">Search</button>
    <button id="syncProvided">Sync provided.txt</button>
  </div>

  <h3>Results</h3>
  <div id="results"><em>No results yet</em></div>

  <script>
    async function fetchLogs(){
      const r = await fetch('/logs.txt', {cache:'no-store'});
      if(!r.ok) throw new Error('logs fetch failed '+r.status);
      return await r.text();
    }

    function matchLines(text, keywords){
      const lines = text.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
      const kw = keywords.map(k=>k.trim().toLowerCase()).filter(Boolean);
      return lines.filter(l=>{
        if(kw.length===0) return true;
        const low = l.toLowerCase();
        return kw.some(k => low.includes(k));
      });
    }

    async function claimLines(candidates, limit){
      const r = await fetch('/claim', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ lines: candidates, limit })
      });
      if(!r.ok) return { claimed: [], rejected: candidates };
      const json = await r.json();
      return { claimed: json.claimed || [], rejected: json.rejected || [] };
    }

    document.getElementById('search').addEventListener('click', async ()=>{
      try{
        document.getElementById('results').textContent = 'Searching...';
        const txt = await fetchLogs();
        const kws = (document.getElementById('kw').value || '').split(',').map(s=>s.trim()).filter(Boolean);
        const candidates = matchLines(txt, kws);
        if(candidates.length === 0){
          document.getElementById('results').textContent = 'No matches';
          return;
        }
        const limit = Number(document.getElementById('limit').value) || 10;
        const {claimed, rejected} = await claimLines(candidates, limit);
        // show claimed only
        if(claimed.length === 0){
          document.getElementById('results').textContent = 'No unclaimed lines available (all were claimed by others)';
        } else {
          document.getElementById('results').innerHTML = '<pre>' + claimed.join('\\n') + '</pre>';
        }
      }catch(err){
        document.getElementById('results').textContent = 'Error: ' + err.message;
      }
    });

    // optional: fetch provided.txt and show count
    document.getElementById('syncProvided').addEventListener('click', async ()=>{
      try{
        const r = await fetch('/provided.txt', {cache:'no-store'});
        if(!r.ok) { alert('No provided.txt'); return; }
        const txt = await r.text();
        const lines = txt.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
        alert('Provided has ' + lines.length + ' lines');
      }catch(e){ alert('Error: '+e.message); }
    });
  </script>
</body>
  </html>
